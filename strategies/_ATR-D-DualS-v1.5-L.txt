{-------------------------------------------------------------
 Strategy: Buy & Hold with ATR Trailing Stop - Dual Symbol (Leveraged ETF)
 Version: 1.5-DualSymbol (Cap-on-Entry + Entry Ratchet - Hybrid Model)
 Date: 2026-01-08
 Platform: TradeStation EasyLanguage
 Timeframe: Daily bars (same timeframe, different symbols)

 Description: LONG-ONLY buy-and-hold strategy that analyzes an
              index ETF (Data2) for volatility signals but trades
              a leveraged version (Data1). Uses HYBRID MODEL for
              optimal signal stability and correct price scaling.

 Dual Symbol Setup (HYBRID MODEL):
 - Data1 = Leveraged ETF (execution) - e.g., TQQQ, UPRO, SOXL
 - Data2 = Index ETF (analysis) - e.g., QQQ, SPY, SOXX
 - Same timeframe (daily bars)

 Hybrid Calculation Distribution:
 - Entry signals (ATR, BuyTouchLevel): Data1 (correct price scale)
 - Stop tightening (BB Width): Data2 (stable volatility signal)
 - Stop calculations (ATR, HL2): Data1 (actual traded instrument)
 - All trades executed on Data1

 Key Features:
 - LONG ONLY (no short positions)
 - ATR trailing stop (server-side via SetDollarTrailing)
 - BB tightening: Contracts stop during low volatility (from Data2)
 - Multiple scaling methods: Linear, Square Root, Exponential
 - Floating Entry: BuyTouchLevel = Close(Data1) + (ATR_EMA(Data1) x Multiplier)
 - EMA smoothing reduces ATR whipsaws while staying responsive
 - Entry level recalculated every bar when flat

 Entry Signals:
 - Long: Buy-If-Touched above floating level (calculated from Data1)
 - BuyTouchLevel = Close(Data1) + (ATR_EMA(Data1) x ATRBuyMultiplier)
 - Entry uses Data1's own volatility (correct price scale)
 - Recalculated every bar when flat (follows Data1 price)

 Exit Signals:
 - ATR trailing stop hit (calculated from Data1, tightened by Data2 BB)
 - Stop tightening uses Data2 BB Width (cleaner volatility signal)
 - NO OTHER EXIT CONDITIONS (always in market or waiting for re-entry)

 Position Sizing:
 - P/L reinvestment based on cumulative performance
 - Shares calculated using Data1 close price (leveraged ETF)

 Why Hybrid Model:
 - Entry on Data1: No price scale conversion needed
 - Tightening from Data2: Filters leveraged ETF noise
 - Best of both: Correct scaling + stable signals
--------------------------------------------------------------}

Inputs:
	Name("Your strategy name")	  [DisplayName = "Displays in Strategy Name Column for ID"],
    InitialInvestment(10000)      [DisplayName = "Initial Capital ($)"],
    RunLive(false)                [DisplayName = "Run Live Mode (Baseline P/L)"],

    // ATR Trailing Stop Parameters
    ATR_Period(14)                [DisplayName = "[4-70][1] ATR Period (Stop Loss)"],
    ATR_Multiplier(2.0)           [DisplayName = "[1-30][.25] ATR Multiplier (Stop Distance)"],

    // Bollinger Band Tightening Parameters
    BB_Length(20)                 [DisplayName = "[6-70][2] BB Length (Volatility)"],
    BB_Deviation(2.0)             [DisplayName = "[1-4][.25] BB Std Deviations"],
    Vol_Threshold(0.10)           [DisplayName = "[.02-.4][.02] BB Width Threshold (Tightening)"],
    Min_Tightening(0.10)          [DisplayName = "[.1-.95][.05] Min Tightening Multiplier"],

    // Scaling Method for BB Tightening
    Scaling_Method(0)             [DisplayName = "[0-2][1] BB Scaling Method (0=Lin,1=Sqrt,2=Exp)"],

    // Re-Entry Parameters (Floating with EMA Smoothed ATR)
    ATRBuy_Period(14)             [DisplayName = "[4-70][1] ATR Period (Entry)"],
    ATRBuyMultiplier(2.0)         [DisplayName = "[.5-20][.25] ATR Multiplier (Entry Buffer)"],
    ATR_Smooth_Period(5)          [DisplayName = "[1-20][1] ATR EMA Smoothing Period"],
    // Entry_Ratchet hardcoded to 0 (Float mode) - removed from optimization grid
    // Analysis showed Entry_Ratchet=0 consistently outperformed in all v1.5 optimizations
    // while doubling grid size (100% increase). Keeping code for manual testing if needed.
    Entry_Ratchet(0)              [DisplayName = "Entry Ratchet (HARDCODED=0, not optimized)"],

    // Price Selection for BB Calculations (Data2)
    EquityPrice_Method(0)         [DisplayName = "[0-1][1] Price Method (0=TypicalPrice,1=Close)"],

    PrintTesting(false)           [DisplayName = "Enable Debug Output"];

Variables:
    // Price Calculation
    CurrentPrice(0),
    HL2(0),

    // ATR and Stop Management
    ATR_Value(0),
    BasicStop(0),
    FinalStop_Long(0),
    StopDistance(0),
    TrailAmtPerShare(0),

    // Bollinger Band Volatility
    BB_Width(0),
    BB_Multiplier(1.0),

    // Opening Stop Protection (4x 70-day ATR cap)
    ATR_Baseline(0),
    MaxStopDistance(0),
    ATR_Stop_Distance(0),

    // Re-Entry with EMA Smoothed ATR
    ATRBuy_Value(0),
    double ATR_Entry_Smooth(0),
    BuyTouchLevel(0),
    NewBuyTouchLevel(0),

    // P/L Reinvestment Variables
    EffNP(0),
    BaseNP(0),
    BaseTT(0),
    bool BaselineSet(false),
    bool InRealTime(false),
    CapitalForNextTrade(0),
    SharesToBuy(0),

    // Tracking
    PrevMarketPosition(0),

    // Debug
    string printableDate(""),
    string ScalingMethodName(""),
    string PriceMethodName("");

// CRITICAL: Tell TradeStation trail amount is per SHARE, not total position
once SetStopShare;

// -------------------------------------------------------------
// Initialize
// -------------------------------------------------------------
If CurrentBar = 1 then begin
    If Scaling_Method = 0 then
        ScalingMethodName = "Linear"
    else If Scaling_Method = 1 then
        ScalingMethodName = "SquareRoot"
    else If Scaling_Method = 2 then
        ScalingMethodName = "Exponential"
    else
        ScalingMethodName = "Unknown";

    If EquityPrice_Method = 0 then
        PriceMethodName = "TypicalPrice"
    else
        PriceMethodName = "Close";

    if PrintTesting then begin
        Print("LONG-ONLY DUAL SYMBOL HYBRID MODEL");
        Print("Data1=Leveraged ETF, Data2=Index ETF");
        Print("Price Method: ", PriceMethodName, " | BB Scaling: ", ScalingMethodName);
        Print("Entry: Data1 (correct scale) | Tightening: Data2 (stable signal)");
    end;
end;

// -------------------------------------------------------------
// Set Current Price for BB calculations (Data2 - Index ETF)
// -------------------------------------------------------------
If EquityPrice_Method = 0 then
    CurrentPrice = TypicalPrice of Data2
else
    CurrentPrice = Close of Data2;

// Calculate HL2 for base stop from Data1 (Leveraged ETF)
HL2 = (High + Low) / 2;  // Data1 implied

// -------------------------------------------------------------
// Calculate ATR for Stop Loss (Data1 - Leveraged ETF)
// CRITICAL: Must use Data1's actual volatility for stops
// -------------------------------------------------------------
If CurrentBar > ATR_Period then
    ATR_Value = AvgTrueRange(ATR_Period)  // Data1 implied
else
    ATR_Value = 0;

// -------------------------------------------------------------
// Calculate ATR Baseline for Opening Stop Protection
// Cap at 4x 70-day ATR to limit opening risk during volatility spikes
// This protection fades as trailing stop tightens via BB
// -------------------------------------------------------------
If CurrentBar > 70 then begin
    ATR_Baseline = AvgTrueRange(70);  // Data1 implied
    MaxStopDistance = ATR_Baseline * 4;
end
else begin
    ATR_Baseline = 0;
    MaxStopDistance = 0;
end;

// -------------------------------------------------------------
// Calculate Bollinger Band Width (Data2 - Index ETF)
// HYBRID: Use Data2 for cleaner volatility tightening signal
// -------------------------------------------------------------
If CurrentBar of Data2 > BB_Length then begin
    // CRITICAL: BollingerBandWidth requires a price SERIES with historical data
    // Calculate from Data2 (Index) for stable volatility signal
    // NOTE: Must use "Close of Data2" explicitly inside the function -
    // the "of Data2" suffix doesn't propagate to arguments
    BB_Width = BollingerBandWidth(Close of Data2, BB_Length, BB_Deviation, -BB_Deviation);

    if PrintTesting and CurrentBar of Data2 = BB_Length + 1 then begin
        printableDate = FormatDate("ddd MMM dd yy", ElDateToDateTime(Date of Data2));
        Print(printableDate, " BB_Width FIRST CALC (Data2): ", BB_Width:0:4);
        Print("  Using Close of Data2, BB_Length=", BB_Length:0:0);
        Print("  BB_Deviation=", BB_Deviation:0:2, " Data2 Close=", Close of Data2:0:2);
    end;
end
else
    BB_Width = 0;

// -------------------------------------------------------------
// Calculate ATR for Buy-If-Touched Re-Entry (Data1 - Leveraged ETF)
// HYBRID: Use Data1's own ATR for entry (correct price scale)
// -------------------------------------------------------------
If CurrentBar > ATRBuy_Period then
    ATRBuy_Value = AvgTrueRange(ATRBuy_Period)  // Data1 implied
else
    ATRBuy_Value = 0;

// -------------------------------------------------------------
// Smooth ATR with EMA for Entry (Data1)
// -------------------------------------------------------------
If ATRBuy_Value > 0 then
    ATR_Entry_Smooth = XAverage(ATRBuy_Value, ATR_Smooth_Period)  // Data1 implied
else
    ATR_Entry_Smooth = 0;

// -------------------------------------------------------------
// Calculate Floating Buy-If-Touched Level (Data1 - Leveraged ETF)
// HYBRID: Uses Data1's price and ATR (correct scale, no conversion needed)
// Entry_Ratchet=0: Recalculates every bar (floats with price)
// Entry_Ratchet=1: Only lowers entry level, never raises (catches slow drifts)
// -------------------------------------------------------------
If ATR_Entry_Smooth > 0 and MarketPosition = 0 then begin
    NewBuyTouchLevel = Close + (ATR_Entry_Smooth * ATRBuyMultiplier);  // Data1 implied

    If Entry_Ratchet = 0 then begin
        // Floating mode: always use new calculated level
        BuyTouchLevel = NewBuyTouchLevel;
    end
    else begin
        // Ratchet mode: only lower, never raise
        If BuyTouchLevel = 0 or NewBuyTouchLevel < BuyTouchLevel then
            BuyTouchLevel = NewBuyTouchLevel;
    end;

    if PrintTesting then begin
        printableDate = FormatDate("ddd MMM dd yy", ElDateToDateTime(Date));
        Print(printableDate, " BuyTouch(Data1)=", BuyTouchLevel:0:2,
              " (Data1 Close=", Close:0:2, " + ATR_EMA=", ATR_Entry_Smooth:0:3,
              " x ", ATRBuyMultiplier:0:2, ")",
              " [Ratchet=", Entry_Ratchet, ", New=", NewBuyTouchLevel:0:2, "]");
    end;
end
else If MarketPosition <> 0 then begin
    BuyTouchLevel = 0;  // Reset when in position
end;

// -------------------------------------------------------------
// Calculate BB Multiplier for Stop Tightening
// HYBRID: Uses Data2 BB Width for stable tightening signal
// -------------------------------------------------------------
If BB_Width >= Vol_Threshold then begin
    // Normal volatility: No tightening
    BB_Multiplier = 1.0;
end
else begin
    // Low volatility: Apply tightening based on scaling method

    // METHOD 0: LINEAR SCALING (Original)
    If Scaling_Method = 0 then begin
        BB_Multiplier = BB_Width / Vol_Threshold;
    end;

    // METHOD 1: SQUARE ROOT SCALING (Gentler)
    If Scaling_Method = 1 then begin
        BB_Multiplier = SquareRoot(BB_Width / Vol_Threshold);
    end;

    // METHOD 2: EXPONENTIAL SCALING (More Aggressive)
    If Scaling_Method = 2 then begin
        BB_Multiplier = Square(BB_Width / Vol_Threshold);
    end;

    // Apply minimum to prevent over-tightening
    If BB_Multiplier < Min_Tightening then
        BB_Multiplier = Min_Tightening;
end;

if PrintTesting and BB_Multiplier < 1.0 then begin
    printableDate = FormatDate("ddd MMM dd yy", ElDateToDateTime(Date));
    Print(printableDate, " BB TIGHTENING (", ScalingMethodName, "): Data2_BBWidth=", BB_Width:0:4,
          " Threshold=", Vol_Threshold:0:2, " Multiplier=", BB_Multiplier:0:3);
end;

// -------------------------------------------------------------
// Baseline Logic (RunLive mode)
// -------------------------------------------------------------
InRealTime = (GetAppInfo(aiRealTimeCalc) = 1);

If RunLive then begin
    If InRealTime and not BaselineSet then begin
        if PrintTesting then
            Print("REALTIME BASELINE SET: NetProfit=", NetProfit, " TotalTrades=", TotalTrades);
        BaseNP = NetProfit;
        BaseTT = TotalTrades;
        BaselineSet = true;
    end;

    If BaselineSet then begin
        EffNP = NetProfit - BaseNP;
        If TotalTrades <= BaseTT then
            EffNP = 0;
    end
    else begin
        EffNP = -InitialInvestment;
    end;
end
else begin
    EffNP = NetProfit;
end;

// -------------------------------------------------------------
// Capital & Position Sizing
// CRITICAL: Based on Data1 price (Leveraged ETF)
// -------------------------------------------------------------
CapitalForNextTrade = InitialInvestment + EffNP;

If CapitalForNextTrade < 0 then
    CapitalForNextTrade = 0;

// Position sizing based on Data1 Close (Leveraged ETF actual price)
If Close > 0 then  // Data1 implied
    SharesToBuy = IntPortion(CapitalForNextTrade / Close)
else
    SharesToBuy = 0;

If SharesToBuy < 0 then
    SharesToBuy = 0;

// -------------------------------------------------------------
// ENTRY LOGIC: Buy-If-Touched (LONG ONLY)
// Signal calculated from Data1, execution on Data1
// -------------------------------------------------------------
If CurrentBar > MaxList(ATR_Period, ATRBuy_Period) and
   CurrentBar of Data2 > BB_Length and
   ATR_Value > 0 and ATRBuy_Value > 0 and SharesToBuy > 0 then begin

    // LONG ENTRY: Buy-If-Touched when flat
    If MarketPosition = 0 and BuyTouchLevel > 0 then begin
        // Enter long on Data1 (Leveraged ETF)
        Buy ("LE-BuyTouch") SharesToBuy shares Next Bar at BuyTouchLevel Stop;

        // CRITICAL: Set initial stop for entry bar (Data1 calculations)
        // Apply opening stop protection: cap at 4x 70-day ATR
        ATR_Stop_Distance = ATR_Value * ATR_Multiplier;
        If MaxStopDistance > 0 and ATR_Stop_Distance > MaxStopDistance then
            ATR_Stop_Distance = MaxStopDistance;
        BasicStop = HL2 - ATR_Stop_Distance;
        FinalStop_Long = BasicStop;
        TrailAmtPerShare = Close - BasicStop;

        If TrailAmtPerShare > 0 then
            SetDollarTrailing(TrailAmtPerShare);

        if PrintTesting then begin
            printableDate = FormatDate("ddd MMM dd yy", ElDateToDateTime(Date));
            Print(printableDate, " LONG ENTRY | Buy-If-Touched | Shares=", SharesToBuy,
                  " TouchLevel(Data1)=", BuyTouchLevel:0:2);
            Print(printableDate, " [ENTRY] Data1: InitialStop=", BasicStop:0:2,
                  " TrailAmt=", TrailAmtPerShare:0:2, " Close=", Close:0:2);
        end;
    end;

end;

// -------------------------------------------------------------
// STOP LOSS MANAGEMENT: ATR Trailing with BB Tightening
// HYBRID: Stops from Data1, Tightening from Data2
// Uses SetDollarTrailing for server-side execution
// -------------------------------------------------------------

// LONG Position Stop
If MarketPosition = 1 and ATR_Value > 0 then begin
    // Step 1: Calculate BasicStop from Data1 (Leveraged ETF)
    // NO cap here - cap only applies at entry to limit initial risk
    // Wide stops are allowed during position to avoid premature exits
    BasicStop = HL2 - (ATR_Value * ATR_Multiplier);

    if PrintTesting then begin
        printableDate = FormatDate("ddd MMM dd yy", ElDateToDateTime(Date));
        Print(printableDate, " [LONG DEBUG] Data1: HL2=", HL2:0:2, " ATR=", ATR_Value:0:3,
              " Multiplier=", ATR_Multiplier:0:2, " BasicStop=", BasicStop:0:2);
    end;

    // Step 2: Calculate FinalStop (trails upward only)
    If FinalStop_Long = 0 then begin
        FinalStop_Long = BasicStop;
        if PrintTesting then
            Print(printableDate, " [LONG DEBUG] INITIALIZING FinalStop_Long=", FinalStop_Long:0:2);
    end
    else If BasicStop > FinalStop_Long then begin
        if PrintTesting then
            Print(printableDate, " [LONG DEBUG] TRAILING UP: Old=", FinalStop_Long:0:2,
                  " New=", BasicStop:0:2, " Diff=", (BasicStop - FinalStop_Long):0:2);
        FinalStop_Long = BasicStop;
    end
    else begin
        if PrintTesting then
            Print(printableDate, " [LONG DEBUG] HOLDING: FinalStop=", FinalStop_Long:0:2,
                  " BasicStop=", BasicStop:0:2, " (not trailing)");
    end;

    // Step 3: Calculate distance from Close to FinalStop
    StopDistance = Close - FinalStop_Long;

    if PrintTesting then begin
        Print(printableDate, " [LONG DEBUG] Data1: Close=", Close:0:2, " FinalStop=", FinalStop_Long:0:2,
              " StopDistance=", StopDistance:0:2);
        Print(printableDate, " [LONG DEBUG] Data2: BB_Width=", BB_Width:0:4,
              " BB_Multiplier=", BB_Multiplier:0:3);
    end;

    // Step 4: Apply BB multiplier from Data2 to Data1 stop distance
    // HYBRID: Data2's BB Width tightens Data1's stop
    TrailAmtPerShare = StopDistance * BB_Multiplier;

    if PrintTesting then begin
        Print(printableDate, " [LONG DEBUG] HYBRID: StopDistance(Data1)=", StopDistance:0:2,
              " x BB_Mult(Data2)=", BB_Multiplier:0:3, " = TrailAmt=", TrailAmtPerShare:0:2);
    end;

    // CRITICAL: If < 0, price has already dropped below FinalStop
    If TrailAmtPerShare < 0 then begin
        Sell ("LX-StopBreach") Next Bar at Market;

        if PrintTesting then begin
            printableDate = FormatDate("ddd MMM dd yy", ElDateToDateTime(Date));
            Print(printableDate, " ***** LONG STOP BREACHED! Data1 Close=", Close:0:2,
                  " FinalStop=", FinalStop_Long:0:2, " EXITING AT MARKET *****");
        end;
    end
    else begin
        SetDollarTrailing(TrailAmtPerShare);

        if PrintTesting then begin
            printableDate = FormatDate("ddd MMM dd yy", ElDateToDateTime(Date));
            Print(printableDate, " LONG STOP: Data1 Close=", Close:0:2, " FinalStop=", FinalStop_Long:0:2,
                  " StopDist=", StopDistance:0:2, " Data2_BBMult=", BB_Multiplier:0:3,
                  " TrailAmt=", TrailAmtPerShare:0:2);
        end;
    end;
end
else If MarketPosition <> 1 then begin
    // Reset when not in long position
    FinalStop_Long = 0;
end;

// -------------------------------------------------------------
// Debug Output
// -------------------------------------------------------------
if PrintTesting and mod(CurrentBar, 20) = 0 then begin
    printableDate = FormatDate("ddd MMM dd yy", ElDateToDateTime(Date));
    Print("========================================");
    Print(printableDate, " LONG-ONLY DUAL SYMBOL STATUS");
    Print("Data1 (Leveraged): ATR(", ATR_Period, ")=", ATR_Value:0:3, " Multiplier=", ATR_Multiplier:0:2);
    Print("Data1 (Leveraged): Close=", Close:0:2, " BuyTouchLevel=", BuyTouchLevel:0:2);
    Print("Data1 (Entry ATR): ATR_Raw=", ATRBuy_Value:0:3, " ATR_EMA=", ATR_Entry_Smooth:0:3);
    Print("Data2 (Index): BB_Width=", BB_Width:0:4, " Threshold=", Vol_Threshold:0:2);
    Print("Data2 (Index): Close=", Close of Data2:0:2);
    Print("BB Multiplier=", BB_Multiplier:0:3, " (", ScalingMethodName, ")");
    Print("MarketPosition=", MarketPosition, " Capital=", CapitalForNextTrade:0:2);
    Print("========================================");
end;

// -------------------------------------------------------------
// Update Previous Position for Next Bar
// -------------------------------------------------------------
PrevMarketPosition = MarketPosition;

// -------------------------------------------------------------
// Close any open position at END OF OPTIMIZATION ONLY
// Safe for live trading and backtesting - only triggers during optimization
// -------------------------------------------------------------
If LastBarOnChart and GetAppInfo(aiOptimizing) = 1 then begin
    // We're on the last bar AND we're in optimization mode
    // This closes positions for accurate optimization P/L calculation

    If MarketPosition = 1 then
        Sell ("LX-EndOfTest") this bar on Close;
end;

{-------------------------------------------------------------
 IMPLEMENTATION NOTES - LONG-ONLY DUAL SYMBOL HYBRID MODEL
--------------------------------------------------------------
 This strategy implements a LONG-ONLY buy-and-hold approach
 with intelligent trailing stop management using HYBRID MODEL.

 Data Distribution:
 - Data1 (Leveraged ETF): All entry/stop ATR calculations
 - Data2 (Index ETF): BB Width for tightening signal only
 - Hybrid Model: Correct price scaling + stable signals

 Key Features:

 1. ATR-Based Trailing Stop (Data1):
    - Stop distance = Data1 ATR x Multiplier
    - Uses SetDollarTrailing for SERVER-SIDE execution
    - Trails automatically as Data1 price moves favorably

 2. BB Tightening (Data2):
    - Measures volatility via Data2 BB Width
    - When Data2 BBWidth < Threshold: Tighten Data1 stop
    - Cleaner signal than using Data1's amplified volatility

 3. Floating Entry (Data1):
    - BuyTouchLevel = Data1 Close + (Data1 ATR_EMA x Mult)
    - Recalculated every bar when flat
    - No price conversion needed
    - Correct scale for leveraged instrument

 4. Position Sizing (Data1):
    - Shares = Capital / Data1 Close
    - Based on actual traded instrument price
    - P/L reinvestment for compounding

 Trading Logic:
 - LONG ONLY on Data1 (leveraged ETF)
 - Enter on buy-if-touched breakout (Data1 level)
 - Hold position with trailing stop (Data1 ATR)
 - Stop tightens via Data2 BB volatility signal
 - Exit ONLY on stop hit (no other exit conditions)

 Setup Instructions:
 1. Add Data1 (TQQQ, UPRO, SOXL) as primary symbol
 2. Add Data2 (QQQ, SPY, SOXX) as secondary symbol
 3. Both on same timeframe (daily recommended)
 4. Apply strategy to chart
--------------------------------------------------------------}

{-------------------------------------------------------------
 CHANGE LOG
--------------------------------------------------------------
 v1.4-DualSymbol (Long-Only) - 2025-11-25
 - Rebuilt from v1.4-BiDirectional-DualSymbol
 - Removed all short-related code and inputs
 - Removed Entry_Mode, Trend_Filter, Both_Triggered_Mode
 - Simplified entry logic to long-only from flat
 - Kept Hybrid Model: Entry from Data1, Tightening from Data2
 - Kept EMA-smoothed ATR for floating entry level

 Based on v1.4-BiDirectional-DualSymbol - 2025-11-24
 - Dual symbol support with HYBRID MODEL
 - Entry calculations from Data1 (correct price scale)
 - BB tightening from Data2 (stable volatility signal)
 - EMA smoothing for ATR component
--------------------------------------------------------------}
